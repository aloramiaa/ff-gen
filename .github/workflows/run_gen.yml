name: Run Account Generator

on:
  workflow_dispatch:
    inputs:
      region:
        description: 'Target Region (IND, ID, BR, ME, VN, TH, CIS, BD, PK, SG, SAC, TW)'
        required: true
        default: 'IND'
        type: choice
        options:
        - IND
        - ID
        - BR
        - ME
        - VN
        - TH
        - CIS
        - BD
        - PK
        - SG
        - SAC
        - TW
      count:
        description: 'Number of accounts to generate'
        required: true
        default: '100'
        type: string
      name_prefix:
        description: 'Account Name Prefix'
        required: true
        default: 'udhaya'
        type: string
      password_prefix:
        description: 'Password Prefix'
        required: true
        default: 'udhaya'
        type: string
      rarity:
        description: 'Rarity Threshold (1-10)'
        required: false
        default: '4'
        type: string
      threads:
        description: 'Number of Threads'
        required: false
        default: '40'
        type: string
      ghost_mode:
        description: 'Enable Ghost Mode'
        required: false
        default: false
        type: boolean
      r2_bucket:
        description: 'Cloudflare R2 Bucket Name'
        required: false
        type: string
        default: 'ff-gen-bucket'

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests pycryptodome colorama urllib3 psutil boto3

    - name: Run Generator
      env:
        REGION: ${{ inputs.region }}
        COUNT: ${{ inputs.count }}
        NAME_PREFIX: ${{ inputs.name_prefix }}
        PASS_PREFIX: ${{ inputs.password_prefix }}
        RARITY: ${{ inputs.rarity }}
        THREADS: ${{ inputs.threads }}
        GHOST: ${{ inputs.ghost_mode }}
        R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
        R2_ACCESS_KEY: ${{ secrets.R2_ACCESS_KEY }}
        R2_SECRET_KEY: ${{ secrets.R2_SECRET_KEY }}
        R2_BUCKET: ${{ inputs.r2_bucket }}
      run: |
        REGION_ARG="$REGION"
        if [ "$GHOST" = "true" ]; then
          REGION_ARG="GHOST"
        fi
        
        echo "Running generator for region: $REGION_ARG, count: $COUNT"
        
        # Build command arguments
        CMD_ARGS="--mode cli --region $REGION_ARG --count $COUNT --name-prefix $NAME_PREFIX --password-prefix $PASS_PREFIX --rarity $RARITY --threads $THREADS"
        
        if [ ! -z "$R2_ENDPOINT" ] && [ ! -z "$R2_ACCESS_KEY" ]; then
          echo "R2 integration enabled."
          CMD_ARGS="$CMD_ARGS --r2-endpoint $R2_ENDPOINT --r2-access-key $R2_ACCESS_KEY --r2-secret-key $R2_SECRET_KEY --r2-bucket $R2_BUCKET"
        fi
        
        python gen.py $CMD_ARGS

    - name: Archive Generated Accounts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: generated-accounts
        path: |
          BIGBULL-ERA/
          !BIGBULL-ERA/**/*.tmpo
        if-no-files-found: warn

    - name: Trigger Next Workflow
      if: success()
      env:
        GH_TOKEN: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}
      run: |
        echo "Triggering next run to create a loop..."
        if [ "${{ secrets.PAT }}" == "" ]; then
          echo "WARNING: Using GITHUB_TOKEN. GitHub may block this automatic trigger to prevent infinite loops."
          echo "To ensure this works, create a Personal Access Token (Classic) with 'repo' and 'workflow' scopes,"
          echo "and save it as a Secret named 'PAT' in your repository."
        fi
        
        gh workflow run run_gen.yml \
          --ref ${{ github.ref_name }} \
          -f region="${{ inputs.region }}" \
          -f count="${{ inputs.count }}" \
          -f name_prefix="${{ inputs.name_prefix }}" \
          -f password_prefix="${{ inputs.password_prefix }}" \
          -f rarity="${{ inputs.rarity }}" \
          -f threads="${{ inputs.threads }}" \
          -f ghost_mode="${{ inputs.ghost_mode }}" \
          -f r2_bucket="${{ inputs.r2_bucket }}"
